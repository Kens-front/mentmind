events {
    worker_connections 1024;
}

http {
    include       /etc/nginx/mime.types;
    default_type  application/octet-stream;

    access_log /var/log/nginx/access.log;
    error_log  /var/log/nginx/error.log;

    map $http_upgrade $connection_upgrade {
        default upgrade;
        ''      close;
    }

    server {
        listen 80;
        server_name localhost;

        location /socket.io/ {
            proxy_pass http://nest:5000;
            proxy_http_version 1.1;
            
            # üîë –ó–∞–≥–æ–ª–æ–≤–∫–∏ –¥–ª—è WebSocket upgrade
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection $connection_upgrade;
            
            # –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ –ø—Ä–æ–∫—Å–∏-–∑–∞–≥–æ–ª–æ–≤–∫–∏
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            
            # –¢–∞–π–º–∞—É—Ç—ã –¥–ª—è –¥–æ–ª–≥–æ–∂–∏–≤—É—â–∏—Ö —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π
            proxy_connect_timeout 7d;
            proxy_send_timeout 7d;
            proxy_read_timeout 7d;
            
            # –û—Ç–∫–ª—é—á–∞–µ–º –±—É—Ñ–µ—Ä–∏–∑–∞—Ü–∏—é
            proxy_buffering off;
        }

        # === Vue 3 (–°—Ç–∞—Ç–∏–∫–∞) ===
        # 1. –°–Ω–∞—á–∞–ª–∞ —Ä–µ–¥–∏—Ä–µ–∫—Ç: /dashboard ‚Üí /dashboard/
        location = /dashboard {
            return 301 /dashboard/;
        }

        # 2. –û—Å–Ω–æ–≤–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫: /dashboard/...
        location /dashboard/ {
            alias /usr/share/nginx/html/vue/;
            index index.html;
            # ‚úÖ Fallback –¥–æ–ª–∂–µ–Ω —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–æ–≤–∞—Ç—å URL, –∞ –Ω–µ –ø—É—Ç–∏ –Ω–∞ –¥–∏—Å–∫–µ
            try_files $uri $uri/ /dashboard/index.html;
        }

        # === NestJS API ===
        # ‚ö†Ô∏è –î–æ–ª–∂–µ–Ω –∏–¥—Ç–∏ –ü–ï–†–ï–î–ï location /
        location /api/ {
            proxy_pass http://nest:5000/;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection $connection_upgrade;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_cookie_path / /;
        }

        # === Nuxt 3 (–û—Å–Ω–æ–≤–Ω–æ–π —Å–∞–π—Ç) ===
        # ‚ö†Ô∏è –î–æ–ª–∂–µ–Ω –±—ã—Ç—å –ü–û–°–õ–ï–î–ù–ò–ú (catch-all)
        location / {
            proxy_pass http://nuxt:3000;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection $connection_upgrade;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header X-Forwarded-Host $host;
            proxy_set_header X-Forwarded-Port $server_port;
            proxy_buffering off;
        }
    }
}