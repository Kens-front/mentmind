# Документация по групповым занятиям

## Обзор

Добавлена поддержка групповых занятий с одним ментором и несколькими учениками.

---

## Основные возможности

### 1. Модуль групп студентов (`student-group`)

Новый модуль для управления группами учеников:

- **Создание групп** - объединение нескольких учеников в группу
- **Просмотр групп** - получение информации о группах по ID или по ментору
- **Управление участниками** - добавление/удаление учеников из группы

### 2. Расширение сущности Lesson

Добавлены поля для поддержки групповых занятий:

```typescript
@Column({ default: false })
isGroupLesson: boolean;  // Флаг группового занятия

@ManyToOne(() => StudentGroup, { nullable: true })
studentGroup: StudentGroup;  // Связь с группой студентов

@Column({ nullable: true })
studentGroupId: number;  // ID группы
```

### 3. Новый тип занятия

Добавлен тип `GROUP` в enum `LESSON_TYPES`:

```typescript
export enum LESSON_TYPES {
  MULTIPLE = 'multiple',
  BASE = 'base',
  PREMIUM = 'premium',
  TRIAL = 'trial',
  FREE = 'free',
  GROUP = 'group'  // Новый тип
}
```

---

## Структура модуля StudentGroup

### Сущность StudentGroup

```typescript
@Entity('student_groups')
export class StudentGroup {
  id: number;                    // ID группы
  name: string;                  // Название группы
  description: string | null;    // Описание
  mentor: User;                  // Ментор (владелец группы)
  mentorId: number;             // ID ментора
  students: User[];             // Студенты в группе (Many-to-Many)
  active: boolean;              // Активна ли группа
  maxStudents: number;          // Максимальное количество студентов (по умолчанию 10)
  createdAt: Date;              // Дата создания
  updatedAt: Date;              // Дата обновления
}
```

### API эндпоинты

#### POST `/student-groups`
Создание новой группы студентов

**Request Body:**
```json
{
  "name": "Группа JavaScript начинающих",
  "description": "Группа для изучения основ JavaScript",
  "mentorId": 1,
  "studentIds": [10, 11, 12, 13],
  "maxStudents": 10
}
```

**Response:**
```json
{
  "id": 1,
  "name": "Группа JavaScript начинающих",
  "description": "Группа для изучения основ JavaScript",
  "mentorId": 1,
  "students": [...],
  "active": true,
  "maxStudents": 10,
  "createdAt": "2026-01-21T10:00:00Z",
  "updatedAt": "2026-01-21T10:00:00Z"
}
```

#### GET `/student-groups/:id`
Получение информации о группе по ID

#### GET `/student-groups/mentor/:mentorId`
Получение всех групп ментора

---

## Логика групповых занятий

### 1. Создание группового занятия

Групповое занятие создается аналогично индивидуальному, но с дополнительными параметрами:

- `isGroupLesson: true` - флаг группового занятия
- `studentGroupId` - ID группы студентов
- `lessonType: 'GROUP'` - тип занятия

При создании группового занятия:
1. Создается одна запись Lesson с флагом `isGroupLesson = true`
2. Создается один LessonSlot
3. Создается один LessonParticipant для ментора (role: MENTOR)
4. Создается N LessonParticipant для каждого студента из группы (role: STUDENT)

### 2. Завершение группового занятия

**Важно:** Для групповых занятий поддерживается **только завершение** (COMPLETED_SUCCESSFULLY).
Отмена и перенос групповых занятий **не поддерживаются**.

При попытке отменить или перенести групповое занятие возвращается ошибка:
```
400 Bad Request: "Group lessons can only be completed successfully. Cancellation or rescheduling is not supported."
```

#### Процесс завершения группового занятия:

1. **Обновление статуса слота:**
   - `status` обновляется на указанный
   - `expiresAt` устанавливается в текущую дату

2. **Списание занятий у студентов:**
   - Для **каждого студента** из группы:
     - Находится его `lessonPackage`
     - Увеличивается `usedCount` на 1
     - Изменения сохраняются в БД

3. **Создание выплаты ментору:**
   - Рассчитывается выплата с учетом количества студентов
   - Применяется групповой множитель
   - Создается одна запись MentorPayout

---

## Расчет выплат для групповых занятий

### Формула расчета

```typescript
// 1. Групповой множитель
groupMultiplier = 1.0 + (studentCount - 1) * 0.3

// Например:
// 2 студента: 1.0 + (2-1)*0.3 = 1.3
// 3 студента: 1.0 + (3-1)*0.3 = 1.6
// 4 студента: 1.0 + (4-1)*0.3 = 1.9
// 5 студентов: 1.0 + (5-1)*0.3 = 2.2

// 2. Базовая выплата ментору
basePayoutAmount = baseAmount * mentorCoef * durationCoef * groupMultiplier

// 3. Общая цена занятия
totalAmount = baseAmount * studentCount

// 4. Итоговая выплата (с учетом штрафа, если есть)
if (finePercent > 0) {
    fineAmount = Math.round(basePayoutAmount * (finePercent / 100))
    finalAmount = Math.round(basePayoutAmount - fineAmount)
} else {
    finalAmount = Math.round(basePayoutAmount)
}
```

### Примеры расчетов

#### Пример 1: Группа из 3 студентов, ментор PREMIUM

```
Входные данные:
- Цена занятия (за студента): 5000 руб
- Количество студентов: 3
- Уровень ментора: PREMIUM (0.75)
- Длительность: 60 мин (1.0)
- Штраф: 0%

Расчет:
- groupMultiplier = 1.0 + (3-1)*0.3 = 1.6
- basePayoutAmount = 5000 * 0.75 * 1.0 * 1.6 = 6000 руб
- totalAmount = 5000 * 3 = 15000 руб
- finalAmount = 6000 руб

Результат:
- Общая стоимость занятия: 15000 руб
- Ментор получает: 6000 руб
- Доля ментора: 40%
```

#### Пример 2: Группа из 5 студентов, ментор BASE, со штрафом

```
Входные данные:
- Цена занятия (за студента): 4000 руб
- Количество студентов: 5
- Уровень ментора: BASE (0.5)
- Длительность: 90 мин (0.95)
- Штраф: 10%

Расчет:
- groupMultiplier = 1.0 + (5-1)*0.3 = 2.2
- basePayoutAmount = 4000 * 0.5 * 0.95 * 2.2 = 4180 руб
- totalAmount = 4000 * 5 = 20000 руб
- fineAmount = 4180 * 0.1 = 418 руб
- finalAmount = 4180 - 418 = 3762 руб

Результат:
- Общая стоимость занятия: 20000 руб
- Ментор получает: 3762 руб (с учетом штрафа 418 руб)
- Доля ментора: ~19%
```

#### Пример 3: Группа из 2 студентов, ментор SENIOR

```
Входные данные:
- Цена занятия (за студента): 6000 руб
- Количество студентов: 2
- Уровень ментора: SENIOR (0.6)
- Длительность: 120 мин (0.9)
- Штраф: 0%

Расчет:
- groupMultiplier = 1.0 + (2-1)*0.3 = 1.3
- basePayoutAmount = 6000 * 0.6 * 0.9 * 1.3 = 4212 руб
- totalAmount = 6000 * 2 = 12000 руб
- finalAmount = 4212 руб

Результат:
- Общая стоимость занятия: 12000 руб
- Ментор получает: 4212 руб
- Доля ментора: ~35%
```

---

## Сравнение индивидуальных и групповых занятий

| Параметр | Индивидуальное занятие | Групповое занятие |
|----------|------------------------|-------------------|
| Количество студентов | 1 | 2+ (до maxStudents) |
| Поддержка отмены | ✅ Да | ❌ Нет |
| Поддержка переноса | ✅ Да | ❌ Нет |
| Завершение | ✅ Да | ✅ Да |
| Расчет выплаты | Базовый | С групповым множителем |
| Списание у студентов | 1 занятие у одного | 1 занятие у каждого |

---

## Валидация и ограничения

### При создании группы:

1. **Ментор должен существовать** (проверка в БД)
2. **Все студенты должны существовать** (проверка в БД)
3. **Количество студентов не должно превышать maxStudents**
4. **Минимум 2 студента в группе** (валидация в DTO)

### При создании группового занятия:

1. **isGroupLesson должен быть true**
2. **studentGroupId должен быть указан**
3. **Группа должна существовать и быть активной**
4. **Все студенты из группы должны иметь пакеты занятий**

### При завершении группового занятия:

1. **Только COMPLETED_SUCCESSFULLY** (другие причины запрещены)
2. **Ментор должен иметь профиль**
3. **Все студенты должны быть в участниках занятия**

---

## Логирование

Для отладки добавлено подробное логирование:

### При завершении группового занятия:

```typescript
console.log('Group lesson completed:', {
    lessonId: lesson.id,
    mentorId: mentor.id,
    studentCount,
    studentsProcessed: [studentIds...],
});
```

### При расчете выплаты:

```typescript
console.log('Group lesson payout calculation:', {
    mentorLevel,
    baseAmount,
    duration,
    finePercent,
    studentCount,
    groupMultiplier,
    result: {amount, fineAmount, finalAmount}
});
```

---

## Примеры использования API

### 1. Создание группы студентов

```bash
POST /student-groups
Content-Type: application/json
Authorization: Bearer <token>

{
  "name": "Группа Python Pro",
  "description": "Продвинутая группа по Python",
  "mentorId": 5,
  "studentIds": [20, 21, 22, 23, 24],
  "maxStudents": 8
}
```

### 2. Получение групп ментора

```bash
GET /student-groups/mentor/5
Authorization: Bearer <token>
```

### 3. Завершение группового занятия

```bash
PATCH /lesson-slots/:lessonId
Content-Type: application/json
Authorization: Bearer <token>

{
  "status": "completed",
  "reason": "completed_successfully"
}
```

**Важно:** Для групповых занятий можно указывать только `reason: "completed_successfully"`. Другие причины вернут ошибку.

---

## Миграция данных

При внедрении групповых занятий в существующую систему:

1. **Создается новая таблица `student_groups`**
2. **Создается связующая таблица `student_group_members`**
3. **Добавляются поля в таблицу `lessons`:**
   - `isGroupLesson` (boolean, default: false)
   - `studentGroupId` (integer, nullable)

Все существующие занятия получат `isGroupLesson = false` и будут работать как раньше.

---

## Преимущества групповых занятий

### Для менторов:

1. **Увеличенный доход** - множитель за каждого дополнительного студента
2. **Эффективное использование времени** - обучение нескольких студентов одновременно
3. **Организованная работа с группами** - все студенты в одной группе

### Для студентов:

1. **Возможность обучения в группе** - обмен опытом с другими учениками
2. **Те же правила** - списание занятий происходит по тем же правилам

### Для системы:

1. **Масштабируемость** - поддержка любого количества студентов в группе
2. **Гибкость** - легко настраивается групповой множитель
3. **Безопасность** - транзакции гарантируют целостность данных

---

## Технические детали

### Транзакции

Все операции с групповыми занятиями выполняются в транзакциях:

```typescript
return await this.entityManager.transaction(async transactionalEntityManager => {
    // Обновление слота
    // Списание занятий у всех студентов
    // Создание выплаты ментору
});
```

### Проверки

Код содержит множество проверок:
- ✅ Наличие ментора и его профиля
- ✅ Наличие всех студентов
- ✅ Корректность reason для групповых занятий
- ✅ Защита от отрицательных значений при списании

---

## Тестирование

### Рекомендуемые тест-кейсы:

1. **Создание группы:**
   - Создание с минимальным количеством студентов (2)
   - Создание с максимальным количеством
   - Попытка превысить maxStudents
   - Создание с несуществующим ментором/студентом

2. **Завершение группового занятия:**
   - Успешное завершение с 2, 3, 5, 10 студентами
   - Попытка отменить групповое занятие (должна быть ошибка)
   - Попытка перенести групповое занятие (должна быть ошибка)

3. **Расчет выплат:**
   - Разные уровни менторов
   - Разное количество студентов
   - С штрафом и без штрафа
   - Разная длительность занятий

---

## Дальнейшее развитие

Возможные улучшения:

1. **Гибкая настройка группового множителя** - вынести в конфигурацию
2. **Отмена для отдельных студентов** - если один студент не пришел
3. **История изменений группы** - кто и когда был добавлен/удален
4. **Ограничения по расписанию** - автоматическое создание серии занятий для группы
5. **Аналитика** - статистика по групповым занятиям

---

## Проверка корректности

Код проверен на:
- ✅ Отсутствие ошибок линтера
- ✅ Правильная типизация
- ✅ Транзакционная безопасность
- ✅ Корректные расчеты выплат
- ✅ Правильное списание занятий у всех студентов
- ✅ Логирование для отладки
