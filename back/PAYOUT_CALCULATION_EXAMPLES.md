# Примеры расчета выплат для менторов

## Обзор изменений

Был проведен полный рефакторинг хендлера `update-lesson-slot.handler.ts` с правильной логикой расчета выплат для менторов.

### Основные улучшения:

1. **Корректный расчет выплат** - учитываются все факторы: уровень ментора, длительность занятия, штрафы
2. **Ясная логика для каждого сценария** - четкое разделение обработки разных причин завершения занятия
3. **Правильное применение штрафов** - штрафы вычитаются из финальной суммы, а не умножаются некорректно
4. **Управление пакетами занятий** - корректное возвращение занятий в пакет при отмене по вине ментора

## Коэффициенты

### Коэффициенты по уровню ментора:
- `JUNIOR`: 0.4 (40% от цены занятия)
- `MIDDLE`: 0.5 (50% от цены занятия)
- `SENIOR`: 0.6 (60% от цены занятия)
- `BASE`: 0.5 (50% от цены занятия)
- `PREMIUM`: 0.75 (75% от цены занятия)

### Коэффициенты по длительности занятия:
- `60 минут` (MIN): 1.0 (базовая ставка)
- `90 минут` (AVERAGE): 0.95 (небольшая скидка 5%)
- `120 минут` (MAX): 0.9 (скидка 10%)

## Сценарии и примеры расчетов

### Базовая формула расчета:
```
basePayoutAmount = baseAmount * mentorCoef * durationCoef
finalAmount = basePayoutAmount - fineAmount (в зависимости от сценария)
```

---

## 1. COMPLETED_SUCCESSFULLY (Успешное завершение)

**Логика:** Ментор получает полную оплату минус штраф (если есть)

### Пример 1.1: Без штрафа
```
Входные данные:
- Цена занятия: 5000 руб
- Уровень ментора: PREMIUM (0.75)
- Длительность: 60 мин (1.0)
- Штраф: 0%

Расчет:
- basePayoutAmount = 5000 * 0.75 * 1.0 = 3750 руб
- fineAmount = 0
- finalAmount = 3750 руб

Результат: Ментор получает 3750 руб
```

### Пример 1.2: Со штрафом 10%
```
Входные данные:
- Цена занятия: 5000 руб
- Уровень ментора: BASE (0.5)
- Длительность: 90 мин (0.95)
- Штраф: 10%

Расчет:
- basePayoutAmount = 5000 * 0.5 * 0.95 = 2375 руб
- fineAmount = 2375 * 0.10 = 238 руб (округлено)
- finalAmount = 2375 - 238 = 2137 руб

Результат: Ментор получает 2137 руб (штраф 238 руб)
```

---

## 2. STUDENT_NO_SHOW (Ученик не пришел)

**Логика:** Не вина ментора, получает полную оплату

### Пример 2.1:
```
Входные данные:
- Цена занятия: 4000 руб
- Уровень ментора: MIDDLE (0.5)
- Длительность: 60 мин (1.0)
- Штраф: игнорируется

Расчет:
- basePayoutAmount = 4000 * 0.5 * 1.0 = 2000 руб
- fineAmount = 0
- finalAmount = 2000 руб

Результат: Ментор получает 2000 руб
```

### Пример 2.2: PREMIUM ментор, длинное занятие
```
Входные данные:
- Цена занятия: 8000 руб
- Уровень ментора: PREMIUM (0.75)
- Длительность: 120 мин (0.9)
- Штраф: игнорируется

Расчет:
- basePayoutAmount = 8000 * 0.75 * 0.9 = 5400 руб
- fineAmount = 0
- finalAmount = 5400 руб

Результат: Ментор получает 5400 руб
```

---

## 3. MENTOR_NO_SHOW (Ментор не пришел)

**Логика:** Серьезное нарушение. Ментор НЕ получает оплату + штраф 50% от цены занятия

### Пример 3.1:
```
Входные данные:
- Цена занятия: 5000 руб
- Уровень ментора: любой (не влияет)
- Длительность: любая (не влияет)

Расчет:
- fineAmount = 5000 * 0.5 = 2500 руб
- finalAmount = 0 руб

Результат: Ментор получает 0 руб и штраф 2500 руб
Дополнительно: Занятие возвращается в пакет ученика (usedCount -= 1)
```

---

## 4. MENTOR_LATE (Ментор опоздал)

**Логика:** Частичное нарушение. Ментор получает 50% оплаты + штраф 20% от базовой цены

### Пример 4.1:
```
Входные данные:
- Цена занятия: 6000 руб
- Уровень ментора: SENIOR (0.6)
- Длительность: 60 мин (1.0)

Расчет:
- basePayoutAmount = 6000 * 0.6 * 1.0 = 3600 руб
- fineAmount = 6000 * 0.2 = 1200 руб
- finalAmount = 3600 * 0.5 = 1800 руб

Результат: Ментор получает 1800 руб и штраф 1200 руб
```

### Пример 4.2: PREMIUM ментор
```
Входные данные:
- Цена занятия: 10000 руб
- Уровень ментора: PREMIUM (0.75)
- Длительность: 90 мин (0.95)

Расчет:
- basePayoutAmount = 10000 * 0.75 * 0.95 = 7125 руб
- fineAmount = 10000 * 0.2 = 2000 руб
- finalAmount = 7125 * 0.5 = 3563 руб (округлено)

Результат: Ментор получает 3563 руб и штраф 2000 руб
```

---

## 5. SCHEDULED_RESCHEDULE (Плановый перенос)

**Логика:** Перенос занятия. Ментор не получает оплату, штрафов нет

### Пример 5.1:
```
Входные данные:
- Цена занятия: любая
- Уровень ментора: любой
- Длительность: любая

Расчет:
- fineAmount = 0
- finalAmount = 0

Результат: Ментор получает 0 руб, штрафов нет
Дополнительно: Занятие возвращается в пакет ученика (usedCount -= 1)
```

---

## Сводная таблица сценариев

| Сценарий | Выплата ментору | Штраф | Возврат в пакет |
|----------|----------------|-------|-----------------|
| COMPLETED_SUCCESSFULLY | basePayoutAmount - fineAmount | lesson.finePercent% от basePayoutAmount | Нет |
| STUDENT_NO_SHOW | basePayoutAmount | Нет | Нет |
| MENTOR_NO_SHOW | 0 | 50% от baseAmount | Да |
| MENTOR_LATE | 50% от basePayoutAmount | 20% от baseAmount | Нет |
| SCHEDULED_RESCHEDULE | 0 | Нет | Да |

---

## Формула расчета basePayoutAmount

```typescript
basePayoutAmount = lesson.price * mentorCoefficient * durationCoefficient

где:
- lesson.price - цена занятия в рублях
- mentorCoefficient - коэффициент по уровню ментора (0.4 - 0.75)
- durationCoefficient - коэффициент по длительности (0.9 - 1.0)
```

---

## Важные примечания

1. **Округление**: Все денежные значения округляются с помощью `Math.round()`
2. **Защита от отрицательных значений**: При возврате занятий в пакет используется `Math.max(0, usedCount - 1)`
3. **Транзакции**: Все операции выполняются в рамках транзакции БД для обеспечения целостности данных
4. **Валидация**: Проверяется наличие профиля ментора перед расчетом выплаты
5. **Логирование**: Все расчеты логируются в консоль для отладки

---

## Проверка корректности

Код был проверен на:
- ✅ Корректность математических расчетов
- ✅ Учет всех типов менторов (JUNIOR, MIDDLE, SENIOR, BASE, PREMIUM)
- ✅ Учет всех длительностей занятий (60, 90, 120 минут)
- ✅ Правильное применение штрафов в каждом сценарии
- ✅ Управление пакетами занятий (возврат при отмене)
- ✅ Отсутствие ошибок линтера
- ✅ Использование транзакций для целостности данных
